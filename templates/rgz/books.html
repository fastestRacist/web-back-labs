{% extends "base.html" %}

{% block lab %}РГР{% endblock %}

{% block main %}
<style>
body {
    font-family: Arial, sans-serif; 
    background:#f4f4f4; 
    margin:0; 
    padding:0;
}
header {
    background:#3498db; 
    color:#fff; 
    padding:15px 0;
}
header .container {
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    width:90%; 
    max-width:1000px; 
    margin:0 auto;
}
header h1 {
    color: black;
    margin:0; 
    font-size:24px;
}
button {
    cursor:pointer; 
    background:#2980b9; 
    color:#fff; 
    border:none; 
    border-radius:4px; 
    padding:6px 10px; 
    font-size:14px;
}
button:hover:not(:disabled){
    background:#1c5980;
}
button:disabled{
    background:#ccc; 
    cursor:default;
}
.container {
    width:90%; 
    max-width:1000px; 
    margin:20px auto; 
    background:#fff; 
    padding:20px; 
    box-shadow:0 0 10px rgba(0,0,0,0.1);
}
.controls, .admin {
    margin-bottom:20px; 
    display:flex; 
    flex-wrap:wrap; 
    justify-content:center; 
    gap:10px;
}
.book {
    display:flex; 
    border:1px solid #ccc; 
    margin:5px; 
    padding:10px; 
    border-radius:5px; 
    background:#fafafa; 
    align-items:center;
}
.book img {
    width:80px; 
    height:120px; 
    object-fit:cover; 
    margin-right:10px;
}
.book-details {
    flex-grow:1;
}
.book-actions {
    display:flex; 
    flex-direction:column; 
    gap:5px;
}
.pagination {
    text-align:center; 
    margin-top:15px;
}
.modal {
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center;
}
.modal-content {
    background:#fff; 
    padding:20px; 
    border-radius:5px; 
    width:300px; 
    position:relative;
}
.modal-content h3 {
    margin-top:0; 
    text-align:center;
}
.modal-content input {
    width:100%; 
    margin:5px 0; 
    padding:8px; 
    border:1px solid #ccc; 
    border-radius:4px;
}
.modal-content button {
    width:100%; 
    margin-top:10px;
}
.modal .close {
    position:absolute; 
    top:5px; 
    right:10px; 
    cursor:pointer; 
    font-weight:bold; 
    font-size:18px;
}
.user-block {
    display:flex; 
    gap:10px; 
    align-items:center;
}
</style>
</head>
<body>

<header>
    <div class="container">
        <h1>Библиотека</h1>
        <div id="auth-container">
            <div class="user-block" id="user-block" style="display:none;">
                <span id="user-info"></span>
                <button onclick="logout()">Выход</button>
                <button onclick="deleteAccount()">Удалить аккаунт</button>
            </div>
            <div id="guest-block">
                <button onclick="showModal('login-modal')">Войти</button>
                <button onclick="showModal('register-modal')">Регистрация</button>
            </div>
        </div>
    </div>
</header>

<div class="controls">
    <input id="filter-title" placeholder="Название">
    <input id="filter-author" placeholder="Автор">
    <input id="filter-publisher" placeholder="Издательство">
    <input id="filter-min-pages" type="number" placeholder="Мин. страниц">
    <input id="filter-max-pages" type="number" placeholder="Макс. страниц">

    <select id="sort-by">
    <option value="id">ID</option>
    <option value="title">Название</option>
    <option value="author">Автор</option>
    <option value="publisher">Издательство</option>
    <option value="pages">Страниц</option>
    </select>

    <select id="sort-order">
    <option value="asc">По возрастанию</option>
    <option value="desc">По убыванию</option>
    </select>

    <button onclick="loadBooks()">Применить</button>
</div>

<div id="books-list"></div>
<div id="pagination" class="pagination"></div>

    <h3>Добавить книгу (для админа)</h3>
    <div class="admin">
        <input id="book-title" placeholder="Название">
        <input id="book-author" placeholder="Автор">
        <input id="book-publisher" placeholder="Издательство">
        <input id="book-pages" placeholder="Страниц" type="number">
        <button onclick="addBook()">Добавить</button>
    </div>
</div>

<!-- Модальное окно входа -->
<div class="modal" id="login-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('login-modal')">&times;</span>
        <h3>Вход</h3>
        <input id="login" placeholder="Логин">
        <input id="password" type="password" placeholder="Пароль">
        <button onclick="login()">Войти</button>
    </div>
</div>

<!-- Модальное окно регистрации -->
<div class="modal" id="register-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('register-modal')">&times;</span>
        <h3>Регистрация</h3>
        <input id="reg-login" placeholder="Логин">
        <input id="reg-password" type="password" placeholder="Пароль">
        <button onclick="register()">Зарегистрироваться</button>
    </div>
</div>

<!-- Модальное окно редактирования книги -->
<div class="modal" id="edit-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('edit-modal')">&times;</span>
        <h3>Редактировать книгу</h3>
        <input id="edit-title" placeholder="Название">
        <input id="edit-author" placeholder="Автор">
        <input id="edit-publisher" placeholder="Издательство">
        <input id="edit-pages" type="number" placeholder="Страниц">
        <button onclick="saveEdit()">Сохранить</button>
    </div>
</div>

<script>
function showModal(id){document.getElementById(id).style.display='flex';}
function closeModal(id){document.getElementById(id).style.display='none';}

async function rpc(method, params={}) {
    const r = await fetch('/rgz/json-rpc-api/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({jsonrpc:'2.0', method, params, id:Date.now()})
    });
    return r.json();
}

let currentPage=1;
let editBookId=null;
let isAdmin=false;
//приветствие пользователя и проверка гость или пользователь
async function getUser(){
    const res = await rpc('get_user_info');
    const userBlock = document.getElementById('user-block');
    const guestBlock = document.getElementById('guest-block');
    const userInfo = document.getElementById('user-info');
    
    if(res.result.is_authenticated){
        guestBlock.style.display='none';
        userBlock.style.display='flex';
        userInfo.innerText=`Привет, ${res.result.login} (${res.result.is_admin?'админ':''})`;
        isAdmin=res.result.is_admin;
    } else {
        guestBlock.style.display='flex';
        userBlock.style.display='none';
        isAdmin=false;
    }
}
//вывод книг
async function loadBooks(page=1){
    currentPage=page;
    const title=document.getElementById('filter-title').value;
    const author=document.getElementById('filter-author').value;
    const publisher=document.getElementById('filter-publisher').value;
    const min_pages=document.getElementById('filter-min-pages').value;
    const max_pages=document.getElementById('filter-max-pages').value;
    const sort_by=document.getElementById('sort-by').value;
    const sort_order=document.getElementById('sort-order').value;
    //получаю книги
    const res = await rpc('get_books',{
        title, author, publisher,
        min_pages: min_pages || null,
        max_pages: max_pages || null,
        page, sort_by, sort_order
    });
    //список книг
    const list=document.getElementById('books-list'); 
    list.innerHTML='';
    if(res.result.books.length===0){
        list.innerHTML='<p style="text-align:center;">Книг не найдено</p>'; 
        return;
    }
    //див под книги вывод
    res.result.books.forEach(b=>{
        const div=document.createElement('div'); 
        div.className='book';
        let actions='';
        if(isAdmin){
        actions=`<div class="book-actions">
        <button onclick="showEditModal(${b.id},'${b.title}','${b.author}','${b.publisher}',${b.pages})">Редактировать</button>
        <button onclick="deleteBook(${b.id})">Удалить</button>
        </div>`;
        }
        div.innerHTML=`<img src="${b.image}" alt="Обложка"><div class="book-details">
    <b>${b.title}</b><br>Автор: ${b.author}<br>Издательство: ${b.publisher}<br>Страниц: ${b.pages}</div>${actions}`;
        list.appendChild(div);
    });
    //пагинация переключение страниц
    const pag=document.getElementById('pagination'); 
        pag.innerHTML='';
        for(let i=1;i<=res.result.total_pages;i++){
            const btn=document.createElement('button'); 
            btn.innerText=i;
            if(i===currentPage) btn.disabled=true;
            btn.onclick=()=>loadBooks(i);
            pag.appendChild(btn);
        }
    }
//вход
async function login(){
    const loginInput=document.getElementById('login').value;
    const password=document.getElementById('password').value;
    const res = await rpc('login',{login:loginInput,password});
    if(res.error){alert(res.error.message); return;}
    closeModal('login-modal'); getUser(); loadBooks();
}
//регистрация
async function register(){
    const loginInput=document.getElementById('reg-login').value;
    const password=document.getElementById('reg-password').value;
    const res = await rpc('register',{login:loginInput,password:password});
    if(res.error){alert(res.error.message); return;}
    closeModal('register-modal'); getUser(); loadBooks();
}
//выход из аккаунта
async function logout(){await rpc('logout'); getUser(); loadBooks();}
//удаление аккаунта
async function deleteAccount(){ if(confirm('Удалить аккаунт?')) { await rpc('delete_account'); getUser(); loadBooks(); }}
//добавление книги
async function addBook(){
    const title=document.getElementById('book-title').value;
    const author=document.getElementById('book-author').value;
    const publisher=document.getElementById('book-publisher').value;
    const pages=document.getElementById('book-pages').value;
    const res = await rpc('add_book',{title,author,publisher,pages});
    if(res.error){alert(res.error.message); return;}
    alert('Книга добавлена'); loadBooks();
}

//Редактирование книг
function showEditModal(id,title,author,publisher,pages){
    editBookId=id;
    document.getElementById('edit-title').value=title;
    document.getElementById('edit-author').value=author;
    document.getElementById('edit-publisher').value=publisher;
    document.getElementById('edit-pages').value=pages;
    showModal('edit-modal');
}
//Сохранение наредактированного
async function saveEdit(){
    const title=document.getElementById('edit-title').value;
    const author=document.getElementById('edit-author').value;
    const publisher=document.getElementById('edit-publisher').value;
    const pages=document.getElementById('edit-pages').value;
    const res = await rpc('update_book',{id:editBookId,title,author,publisher,pages});
    if(res.error){alert(res.error.message); return;}
    closeModal('edit-modal'); loadBooks();
}
//Удаление книги
async function deleteBook(id){
    if(confirm('Удалить книгу?')){
        const res = await rpc('delete_book',id);
        if(res.error){alert(res.error.message); return;}
        loadBooks();
    }
}

getUser(); loadBooks();
</script>
{% endblock %}